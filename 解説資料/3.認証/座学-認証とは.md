## 座学: アプリの「カギ」を持つ仕組み（認証）

### 1. 「認証」ってなんだろう？

ウェブサイトやアプリを使っていると、「ログインしてください」とか「新規登録はこちら」といった画面をよく見かけますよね。これが「認証」の入り口です。

簡単に言うと、**認証とは「あなたが誰であるかを確認し、許可された操作だけをできるようにする仕組み」** のことです。

例えば、X-Cloneアプリでは、

- Aさんが投稿した内容を、Bさんが勝手に編集したり削除したりできては困ります。
- 自分だけのプロフィール情報を設定したいですよね。
- 誰がどの投稿に「いいね！」したか、正確に記録したいです。

これらを実現するために、「今操作しているのは本当にAさんなのか？」「この人はログインしているのか？」を確認する必要があります。これが認証の役割です。

（画像イメージ: `../../資料/2. 認証/1.png` - 鍵と鍵穴、IDカードのような認証のイメージ図）

主な認証の要素は以下の通りです。

- **新規登録 (Sign Up):** 初めてアプリを使う人が、自分のアカウント情報（例: メールアドレス、パスワード、名前など）を登録すること。
- **ログイン (Sign In / Log In):** 既に登録済みの人が、アカウント情報を使って「自分であること」を証明し、アプリの機能を使う許可を得ること。
- **ログアウト (Sign Out / Log Out):** アプリの使用を終え、一時的に「自分であること」の証明を解除すること。
- **セッション管理:** ログインしてからログアウトするまで、あるいは一定時間の間、「ログインしている状態」を保つ仕組み。これにより、ページを移動するたびに毎回ログインし直す必要がなくなります。

### 2. Supabase Auth: かんたん認証機能

今回のX-Cloneアプリでは、認証機能を実装するために **Supabase Auth** を利用します。

- **Supabase Authとは？**
  - Supabaseが提供する認証サービスです。メールアドレスとパスワードによる基本的な認証はもちろん、GoogleやGitHubといった他のサービスのアカウントを使ったソーシャルログイン機能なども簡単に導入できます。
- **Supabase Authのいいところ**
  - **導入が簡単:** 複雑な設定なしに、すぐに認証機能を使い始められます。
  - **安全性が高い:** パスワードの安全な保管（ハッシュ化など、詳しくは後述）や、セキュリティに関する様々なベストプラクティスが取り入れられています。
  - **柔軟性:** ルール設定や他のSupabase機能（データベースやストレージ）との連携もスムーズです。

（画像イメージ: `../../資料/2. 認証/2.png` - Supabase Authのロゴや機能概要図）

### 3. パスワードはどうやって守られるの？（ハッシュ化）

ユーザーさんが登録時に入力したパスワードは、データベースにそのまま保存されるわけではありません。もしそのまま保存されてしまうと、万が一データベースの情報が漏洩した場合、全員のパスワードが悪用されてしまいます。

そこで使われるのが **ハッシュ化** という技術です。

- **ハッシュ化とは？**
  - 元のデータ（この場合はパスワード）を、ある計算式（ハッシュ関数）を使って、全く別の意味のないランダムな文字列に変換することです。
  - 同じパスワードからは必ず同じハッシュ値が生成されますが、ハッシュ値から元のパスワードを割り出すことは非常に困難（ほぼ不可能）です。
  - 例: `password123` → (ハッシュ化) → `x7g3fPqZm0...` (実際はもっと長い文字列)
- **Supabase Authでの扱い:**
  - Supabase Authは、ユーザーが登録したパスワードを自動的にハッシュ化してデータベースに保存します。ログイン時には、入力されたパスワードを同じようにハッシュ化し、データベースに保存されているハッシュ値と比較することで本人確認を行います。
  - これにより、開発者自身もユーザーの実際のパスワードを知ることはなく、安全性が高まります。

（画像イメージ: `../../資料/2. 認証/3.png` - ハッシュ化の概念図、南京錠のアイコンなど）

ですので、「パスワードは安全な場所に保管してください」とよく言われますが、サービス提供側（今回でいえば私たち）も、ユーザーのパスワードそのものではなく、安全に変換された形で扱っているということを知っておきましょう。

### 4. Middleware (ミドルウェア): ページの門番

特定のページ（例えばマイページや投稿編集ページなど）は、ログインしているユーザーにしか見せたくないですよね。そういったアクセスの制御を行うために、Next.jsでは **Middleware (ミドルウェア)** という仕組みを利用できます。

- **Middlewareとは？**
  - リクエストがサーバーに到達してから、実際にページの内容が返されるまでの「中間」で実行される処理のことです。
  - Next.jsのMiddlewareを使うと、特定ページへのアクセスがあった際に、「このユーザーはログインしているか？」をチェックし、ログインしていなければログインページへ強制的に移動させる（リダイレクトする）といった処理を挟むことができます。
  - いわば、各ページへのアクセスの手前にいる「門番」のような役割を果たします。

（画像イメージ: `../../資料/2. 認証/5.png` - Middlewareの処理フロー図、門番のイラストなど）

このチャプターでは、Supabase AuthとMiddlewareを連携させて、認証状態に基づいたアクセス制御の第一歩を実装します。
