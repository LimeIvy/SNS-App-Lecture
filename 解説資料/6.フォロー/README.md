# チャプター6: フォロー機能 (概要)

このチャプターでは、X-Clone アプリにおけるユーザー間のフォロー関係を構築・管理する機能と、フォロー数・フォロワー数を表示する機能の概要を説明します。

## 6.1. Supabase テーブル作成 (`follows`)

- **目的:** ユーザー間のフォロー関係を記録します。
- **主なカラム:**
  - `id` (BIGINT, Primary Key, Generated by default as identity): フォロー関係の一意なID。
  - `follower_id` (UUID, Foreign Key to `public.profile(id)`, Not Nullable): フォローする側のユーザーID。
  - `following_id` (UUID, Foreign Key to `public.profile(id)`, Not Nullable): フォローされる側のユーザーID。
  - `created_at` (TIMESTAMPTZ, Default: `now()` at UTC, Not Nullable): フォロー関係が作成された日時。
- **制約:**
  - `follower_id` と `following_id` の組み合わせに対して UNIQUE 制約 (`follows_unique` または `follows_follower_id_following_id_key`) を追加し、同じユーザーを重複してフォローできないようにします。
  - `ON DELETE CASCADE` を外部キーに設定し、ユーザーが削除された場合にそのユーザーに関連するフォロー関係も自動的に削除されるようにします。

## 6.2. DB 関数作成 (フォロー関連情報取得)

- **目的:** フォロー数、フォロワー数、および特定のユーザー間のフォロー状態を効率的に取得します。
- **作成する関数 (PL/pgSQL, `SECURITY DEFINER` 設定):**
  - `get_following_count(user_profile_id uuid)`: 指定したユーザーがフォローしている他のユーザーの数を返します。
  - `get_followers_count(user_profile_id uuid)`: 指定したユーザーをフォローしている他のユーザーの数を返します。
  - `is_following(user_follower_id uuid, user_following_id uuid)`: `user_follower_id` が `user_following_id` をフォローしている場合に `true` を、そうでない場合に `false` を返します。
- **ポイント:** `SECURITY DEFINER` を使用することで、RLSが有効なテーブルに対しても関数定義者の権限でデータを読み取れるようにし、安全かつ効率的なデータアクセスを実現します。

## 6.3. API ルート作成 (フォロー操作と状態確認)

- **目的:** フロントエンドからフォロー/アンフォロー操作、およびフォロー状態の確認を行えるようにします。
- **認証:** すべてのエンドポイントでユーザー認証を必須とします。

1.  **フォローする (`POST /api/users/[targetUserId]/follow`)**
    - 認証ユーザーが `targetUserId` で指定されたユーザーをフォローします (`follows` テーブルにレコードを挿入)。
2.  **アンフォローする (`DELETE /api/users/[targetUserId]/unfollow`)**
    - 認証ユーザーが `targetUserId` で指定されたユーザーのフォローを解除します (`follows` テーブルからレコードを削除)。
3.  **フォロー状態確認 (`GET /api/users/[targetUserId]/follow_status`)**
    - 認証ユーザーが `targetUserId` で指定されたユーザーをフォローしているかどうかの状態 (`{ isFollowing: boolean }`) を返します。

## 6.4. フロントエンド実装

### 6.4.1. プロフィールページ (`app/[userId]/page.tsx`) でのフォロー機能

- **目的:** 他のユーザーのプロフィールページで、そのユーザーをフォロー/アンフォローできるようにします。
- **State 変数:**
  - `isFollowing` (boolean): ログインユーザーが表示中のプロフィールユーザーをフォローしているか。
  - `isLoadingFollow` (boolean): フォロー/アンフォローAPI呼び出し中のローディング状態。
  - `followerCount` (number): 表示中プロフィールのフォロワー数 (動的に更新するため)。
- **処理フロー:**
  1.  ページ表示時 (`useEffect`):
      - ログインユーザーIDとプロフィールユーザーIDを取得。
      - 自分自身のプロフィールでない場合、`/api/users/[profileUserId]/follow_status` を呼び出し `isFollowing` を初期化。
      - フォロワー数を取得し `followerCount` を初期化。
  2.  フォロー/アンフォローボタンUI:
      - 自分自身のプロフィールではボタンを非表示。
      - `isFollowing` 状態に応じてボタンのテキスト・スタイルを「フォローする」「フォロー中」と切り替え。
      - `isLoadingFollow` が `true` の間はボタンを無効化。
  3.  ボタンクリック時 (`handleFollowToggle` 関数):
      - `isLoadingFollow` を `true` に設定。
      - `isFollowing` 状態に応じて、フォローAPIまたはアンフォローAPIを呼び出す。
      - API成功後、`isFollowing` を反転させ、`followerCount` を増減させる。
      - エラーハンドリング。
      - `finally` で `isLoadingFollow` を `false` に戻す。

### 6.4.2. 投稿詳細ページ (`app/[userId]/[postId]/page.tsx`) でのフォローボタン

- **目的:** 投稿者の情報欄にフォロー/アンフォローボタンを設置します。
- **実装:** プロフィールページと同様のロジックで、投稿者のユーザーIDを対象にフォロー状態の取得、ボタン表示、フォロー/アンフォロー処理を実装します。

### 6.4.3. フォロー数・フォロワー数の表示

- プロフィールページに、DB関数 `get_following_count` および `get_followers_count` を使って取得したフォロー数とフォロワー数を表示します。
- これらの数値は、フォロー/アンフォロー操作が成功した際にフロントエンド側でも同期的に更新します。
