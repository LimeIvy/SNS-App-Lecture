# チャプター7: リプライ機能 (概要)

このチャプターでは、X-Clone アプリにおいて、ユーザーが既存の投稿に対して返信（リプライ）を作成し、それらを表示する機能の概要を説明します。

## 7.1. Supabase テーブル作成 (`replies`)

- **目的:** 投稿への返信コメントを格納します。
- **テーブル名:** `replies`
- **主なカラム:**
  - `id` (BIGINT, Primary Key, Generated by default as identity): リプライの一意なID。
  - `user_id` (UUID, Foreign Key to `public.profile(id)` ON DELETE CASCADE, Not Nullable): リプライを投稿したユーザーのID。
  - `post_id` (UUID, Foreign Key to `public.posts(id)` ON DELETE CASCADE, Not Nullable): リプライ対象の元の投稿ID。
  - `content` (TEXT, Not Nullable, CHECK (`char_length(content) > 0`)): リプライの本文。空の投稿は許可しません。
  - `created_at` (TIMESTAMPTZ, Default: `timezone('utc'::text, now())`, Not Nullable): リプライの投稿日時。
- **ポイント:** `user_id` と `post_id` に外部キー制約を設定し、データの整合性を保ちます。

## 7.2. 型定義の追加 (`types/index.ts`)

- **目的:** リプライデータおよび返信者プロフィール情報を含むリプライデータの型をアプリケーション全体で共通して利用できるように定義します。
- **定義するインターフェース:**
  - `Reply`: `replies` テーブルの基本的なカラム（`id`, `user_id`, `post_id`, `content`, `created_at`）を持つ型。
  - `ReplyWithProfile`: `Reply` 型を拡張し、リプライ投稿者のプロフィール情報（`profile: Profile | null`）をネストして持つ型。`Profile` はチャプター2で定義したユーザープロフィール情報の型を想定します。

## 7.3. API ルート作成

### 7.3.1. 返信作成 API (`POST /api/posts/[postId]/reply`)

- **ファイル:** `app/api/posts/[postId]/reply/route.ts`

```typescript
import { createClient } from "@/utils/supabase/server";
import { NextResponse } from "next/server";

export async function POST(
  request: Request,
  { params }: { params: { postId: string } }
) {
  const supabase = await createClient();

  // 1. 認証状態の確認
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return new NextResponse("Unauthorized", { status: 401 });
  }

  // 2. 返信対象の投稿IDを取得
  const targetPostId = params.postId;

  // 3. リクエストボディから返信内容を取得
  let requestBody;
  try {
    requestBody = await request.json();
  } catch (error) {
    console.error("Request body parsing error:", error);
    return new NextResponse("Invalid request body", { status: 400 });
  }

  const content = requestBody.content;

  if (!content || typeof content !== "string" || content.trim() === "") {
    return new NextResponse(
      "Content is required and must be a non-empty string",
      { status: 400 }
    );
  }

  try {
    // 4. replies テーブルにレコードを挿入
    const { data, error } = await supabase
      .from("replies")
      .insert({
        user_id: user.id,
        post_id: targetPostId,
        content: content.trim(), // 前後の空白を除去
      })
      .select() // 挿入したデータを返す (任意)
      .single();

    // 5. エラーハンドリング
    if (error) {
      console.error("Reply Creation Error:", error);
      // 外部キー制約違反 (存在しない投稿への返信など) を考慮
      if (error.code === "23503") {
        // foreign_key_violation
        return new NextResponse("Invalid post_id or user_id", { status: 400 });
      }
      return new NextResponse("Internal Server Error", { status: 500 });
    }

    // 6. 成功レスポンス (作成されたリソースを返すのが一般的)
    return NextResponse.json(data, { status: 201 }); // Created
  } catch (err) {
    console.error("API Error:", err);
    return new NextResponse("Internal Server Error", { status: 500 });
  }
}
```

- **目的:** 認証済みユーザーが、指定された投稿 (`postId`) に対して新しいリプライを作成できるようにします。

### 7.3.2. 返信一覧取得 API (`GET /api/posts/[postId]/replies`)

- **ファイル:** `app/api/posts/[postId]/replies/route.ts`

```typescript
import { createClient } from "@/utils/supabase/server";
import { NextResponse } from "next/server";

export async function GET(
  request: Request,
  { params }: { params: { postId: string } }
) {
  const supabase = await createClient();

  // 1. 返信を取得したい投稿のID
  const targetPostId = params.postId;

  if (!targetPostId) {
    return new NextResponse("Post ID is required", { status: 400 });
  }

  try {
    // 2. replies テーブルからデータを取得 (profile テーブルと結合)
    const { data, error } = await supabase
      .from("replies")
      .select(
        `
        *,
        profile: profile (
          id,
          name,
          icon
        )
      `
      )
      .eq("post_id", targetPostId)
      .order("created_at", { ascending: false }); // 新しい順

    // 3. エラーハンドリング
    if (error) {
      console.error("Replies Fetch Error:", error);
      return new NextResponse("Internal Server Error", { status: 500 });
    }

    // 4. 成功レスポンス
    return NextResponse.json(data || []); // データがない場合は空配列を返す
  } catch (err) {
    console.error("API Error:", err);
    return new NextResponse("Internal Server Error", { status: 500 });
  }
}
```

- **目的:** 特定の投稿 (`postId`) に紐づく全てのリプライを、各リプライの投稿者情報と共に一覧で取得します。

## 7.4. フロントエンド実装

### 7.4.1. 返信入力フォーム (`components/ReplyForm.tsx`)

- **目的:** ユーザーがリプライ内容を入力し、投稿するためのUIコンポーネント。投稿詳細ページなどで使用されます。
- **コンポーネントの種類:** クライアントコンポーネント (`"use client"`)
- **Props:**
  - `postId` (string): リプライ対象の投稿ID。
  - `onReplySuccess` (function): リプライ投稿成功時に呼び出されるコールバック関数。新しいリプライデータを引数として受け取り、UIの即時更新に使用します。
- **State 変数:**
  - `content` (string): テキストエリアの入力内容。
  - `isLoading` (boolean): API呼び出し中のローディング状態。
  - `error` (string | null): エラーメッセージ。
- **主な機能:**
  - ログインユーザーのアイコンを表示（`useEffect` で `supabase.auth.getUser()` を使用し、`profile` テーブルからアイコンパスを取得）。
  - テキストエリアと送信ボタンを配置。
  - `handleSubmit` 関数:
    - `content` が空でないかチェック。
    - `isLoading` を `true` に設定。
    - `fetch` APIを使用して `/api/posts/[postId]/reply` (POST) に `content` を送信。
    - API成功時 (HTTP 201): `onReplySuccess` コールバックを呼び出し、レスポンスボディ（新しく作成された `ReplyWithProfile` オブジェクト）を渡す。`content` をクリア。
    - エラー発生時は `error` State にメッセージを設定。
    - `finally` ブロックで `isLoading` を `false` に戻す。

### 7.4.2. 投稿詳細ページへの返信一覧表示 (`app/[userId]/[postId]/page.tsx`)

- **目的:** 投稿詳細ページに、その投稿へのリプライを一覧で表示します。
- **State 変数:**
  - `replies` (`ReplyWithProfile[]`): 返信一覧データ。
  - `isLoadingReplies` (boolean): 返信一覧のローディング状態。
  - `repliesError` (string | null): 返信一覧取得時のエラーメッセージ。
- **処理フロー:**
  1.  ページ表示時または `postId` 変更時 (`useEffect`):
      - `isLoadingReplies` を `true` に設定。
      - `/api/posts/[postId]/replies` (GET) APIを呼び出し、返されたリプライ一覧を `replies` Stateにセット。
      - エラーハンドリングを行い、`repliesError` Stateを更新。
      - `finally` で `isLoadingReplies` を `false` に戻す。
  2.  `handleReplySuccess` 関数 ( `ReplyForm` の `onReplySuccess` プロップに渡す):
      - 新しいリプライオブジェクト (`newReply: ReplyWithProfile`) を引数として受け取る。
      - `setReplies(prevReplies => [newReply, ...prevReplies])` のように、既存の `replies` Stateの先頭に新しいリプライを追加し、UIに即時反映させます。
  3.  JSXでの表示:
      - `isLoadingReplies`, `repliesError`, `replies.length` の状態に応じて、ローディング表示、エラーメッセージ、「まだ返信はありません。」メッセージ、またはリプライ一覧を表示。
      - `replies` 配列を `map` し、各リプライアイテムについて以下の情報を表示:
        - リプライ投稿者のアイコン（クリックでプロフィールページへ）。
        - リプライ投稿者の名前。
        - リプライ投稿者のユーザーID。
        - リプライ投稿日時（フォーマット済み）。
        - リプライ内容 (`reply.content`)。
        - (オプション) 各リプライに対するアクションボタン（いいね、さらにリプライなど）。
