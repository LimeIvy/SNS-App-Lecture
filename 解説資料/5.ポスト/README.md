# チャプター5: ポスト機能 (概要)

このチャプターでは、X-Clone アプリの根幹機能である「ポスト」に関連する機能群の実装概要を説明します。具体的には、新規投稿の作成、タイムラインへの表示、個別の投稿詳細ページの表示、そして投稿に対するリアクション（いいね、リツイート）機能について触れます。

## 5.1. 投稿機能とタイムライン表示

### 5.1.1. Supabase テーブル作成 (`posts`)

- **目的:** ユーザーが作成した投稿データを格納します。
- **主なカラム:**
  - `id` (UUID, Primary Key): 投稿の一意なID。
  - `user_id` (UUID, Foreign Key to `auth.users.id` または `profile.id`): 投稿したユーザーのID。
  - `content` (TEXT, Not Nullable): 投稿の本文。
  - `created_at` (TIMESTAMPTZ, Default: `now()`): 投稿日時。
  - (オプション) `image_url` (TEXT, Nullable): 投稿に添付された画像のURL。
- **ポイント:** `posts.user_id` と `profile.id` の間に外部キー制約を設定し、投稿者情報を容易に取得できるようにします。

### 5.1.2. 投稿フォーム実装 (`components/PostForm.tsx`)

- **目的:** ユーザーが新しいポストを作成するためのUIを提供します。
- **コンポーネントの種類:** クライアントコンポーネント (`'use client'`)
- **主な機能:**
  - テキストエリアで投稿内容を入力。
  - 投稿者のアイコンを表示 (ログインユーザーの `profile` テーブルから取得)。
  - 「ポストする」ボタンで投稿処理を実行。
  - `supabase.from('posts').insert()` を使用して、入力内容とログインユーザーのIDを `posts` テーブルに保存。
  - 投稿成功後、テキストエリアをクリア。
  - (オプション) 画像添付機能。

### 5.1.3. タイムライン表示実装 (`app/page.tsx`)

- **目的:** アプリのホームページに、フォローしているユーザーの投稿やリツイートを時系列（新しい順）で表示します。
- **コンポーネントの種類:** サーバーコンポーネント (`async function`)
- **データ取得:**
  - `utils/supabase/server.ts` の `createClient` を使用。
  - `supabase.from('posts').select('*, profile: profile(*)')` のように、`posts` テーブルのデータと、関連する `profile` テーブルの投稿者情報（名前、アイコンなど）を結合して取得します。
  - `order('created_at', { ascending: false })` で新しい投稿が上に表示されるようにソートします。
  - (将来的にはフォローしているユーザーの投稿のみにフィルタリングするロジックや、リツイート表示ロジックを追加)
- **UI:** 取得した投稿データを `components/Post.tsx` コンポーネントに渡し、一覧表示します。

### 5.1.4. 投稿表示コンポーネント (`components/Post.tsx`)

- **目的:** 個々の投稿情報を整形して表示するための再利用可能なコンポーネントです。
- **表示内容:**
  - 投稿者のアイコン、名前、ユーザーID（プロフィールページへのリンク）。
  - 投稿本文 (`content`)。
  - 投稿日時 (`created_at` をフォーマットして表示)。
  - (オプション) 投稿画像。
  - いいね、リツイート、コメント（リプライ）のためのアクションボタン（見た目のみ、機能は後述）。
- **ポイント:**
  - 投稿全体または投稿内容部分をクリックすると投稿詳細ページへ遷移するように `<Link>` を設定します。
  - アイコンクリックでプロフィールページへ遷移。
  - アクションボタンのクリックイベントが、親要素のリンク遷移を妨げないように `e.stopPropagation()` を使用します。

### 5.1.5. 投稿詳細ページの実装 (`app/[userId]/[postId]/page.tsx`)

- **目的:** 特定の投稿を詳細に表示し、関連するリプライなどを確認できるページを提供します。
- **コンポーネントの種類:** 当初サーバーコンポーネントで実装後、リプライ機能などの動的な要素を考慮しクライアントコンポーネント (`"use client"`) に変更。
- **データ取得:**
  - `useParams` フックでURLから `postId` を取得。
  - `useEffect` フック内で、取得した `postId` を基に `utils/supabase/client.ts` の `createClient` を使用して `posts` テーブルから該当投稿のデータ（投稿者プロフィール情報も結合）を非同期で取得します。
  - ローディング状態 (`loading`) とエラー状態 (`error`) を管理し、取得中はローディング表示、失敗時や投稿が見つからない場合はエラーメッセージを表示します。
- **表示内容:**
  - 投稿者のアイコン、名前、ユーザーID。
  - 投稿内容、投稿日時。
  - 返信フォーム (`components/ReplyForm.tsx`) の配置（詳細はチャプター7）。
  - 返信一覧の表示エリア（詳細はチャプター7）。

## 5.2. リアクション機能

### 5.2.1. いいね機能

- **目的:** ユーザーが投稿に対して「いいね」を付けたり外したりできるようにし、各投稿のいいね数を表示します。
- **Supabase テーブル作成 (`likes`)**
  - **主なカラム:** `id`, `user_id` (Foreign Key to `profile.id`), `post_id` (Foreign Key to `posts.id`), `created_at`。
  - **制約:** `user_id` と `post_id` の組み合わせで UNIQUE 制約を設定し、重複いいねを防ぎます。
- **DB 関数作成:**
  - `get_like_count(target_post_id uuid)`: 特定投稿のいいね総数を返します。
  - `is_liked(target_user_id uuid, target_post_id uuid)`: 特定ユーザーが特定投稿をいいねしているかを真偽値で返します。
  - これらの関数は `SECURITY DEFINER` を設定してRLSをバイパスできるようにします。
- **API ルート作成:**
  - `POST /api/posts/[postId]/like`: 認証ユーザーが指定の投稿に「いいね」します (`likes` テーブルにレコード挿入)。
  - `DELETE /api/posts/[postId]/unlike`: 認証ユーザーが指定の投稿の「いいね」を取り消します (`likes` テーブルからレコード削除)。
- **フロントエンド実装 (`components/Post.tsx`, 投稿詳細ページなど):**
  - State変数 (`isLiked`, `likeCount`, `isLoadingLike`) でUIの状態を管理。
  - 投稿表示時に、サーバーサイドで初期状態を取得するか、クライアントサイドで専用APIを叩いて取得。
  - いいねボタン（例: ハートアイコン）といいね数を表示。`isLiked` 状態に応じてボタンのスタイルを動的に変更。
  - ボタンクリックで対応するAPIを呼び出し、成功したらStateを更新してUIに即時反映。

### 5.2.2. リツイート機能

- **目的:** ユーザーが他のユーザーの投稿を自身のフォロワーのタイムラインに共有（リツイート）できるようにします。
- **Supabase テーブル作成 (`retweets`)**
  - **主なカラム:** `id`, `user_id` (リツイートしたユーザーのID), `post_id` (リツイートされた元の投稿ID), `created_at`。
  - **制約:** `user_id` と `post_id` の組み合わせで UNIQUE 制約。
- **DB 関数作成 (いいね機能と同様):**
  - `get_retweet_count(target_post_id uuid)`
  - `is_retweeted(target_user_id uuid, target_post_id uuid)`
- **API ルート作成:**
  - `POST /api/posts/[postId]/retweet`: 投稿をリツイート。
  - `DELETE /api/posts/[postId]/unretweet`: リツイートを取り消す。
- **フロントエンド実装:**
  - いいね機能と同様に、State管理、リツイートボタンと数の表示、API連携を行います。
  - **タイムラインへの影響:** ホームタイムライン (`app/page.tsx`) で、フォローしているユーザー自身の投稿に加え、彼らがリツイートした投稿も取得・表示するロジックが必要になります。リツイートの場合は、誰がリツイートしたかの情報と共に元の投稿内容を表示します。
