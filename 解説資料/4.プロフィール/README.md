# チャプター4: プロフィール (概要)

このチャプターでは、ユーザープロフィール表示、編集機能、およびプロフィールアイコンの画像アップロード機能に関する基本的な実装方針を説明します。

### 4.1. プロフィールページの表示

- **目的:** 各ユーザーのプロフィール情報（名前、自己紹介、アイコンなど）を表示する専用ページを作成します。
- **UI:** `app/[userId]/page.tsx` として、ユーザーIDに基づいて動的にプロフィール情報を表示するページを作成します。
- **データ取得:**
  - サーバーコンポーネントとして実装し、Supabaseから`profile`テーブルの情報を取得します。
  - 名前、自己紹介、アイコンパスなどを表示します。
- **ポイント:** 存在しないユーザーIDの場合は404ページを表示します。

### 4.2. プロフィール編集機能

- **目的:** ユーザーが自身の名前、自己紹介、アイコンなどを編集できるようにします。
- **UI:** プロフィール編集ページ (`app/settings/profile/page.tsx` など) を作成します。
  - 現在のプロフィール情報をフォームの初期値として表示します。
- \*\*APIエンドポイント (`PUT /api/profile`):
  - 認証ユーザーが自身のプロフィール情報（名前、自己紹介、アイコンURLなど）を更新できるようにします。
- **RLS設定 (`profile` テーブル):** ユーザーは自身のプロフィールのみ更新可能に制限します。

### 4.3. プロフィールアイコンの画像アップロード機能 (Supabase Storage)

- **目的:** ユーザーがプロフィールアイコン画像をアップロード・変更できるようにします。
- **Supabase Storage設定:**
  - `profile_icons` バケットを作成します。
  - Public Readを有効にし、認証ユーザーが自身のアイコンのみアップロード/更新できるようにポリシー設定を行います。
- **実装:**
  - プロフィール編集ページにファイル選択機能を追加します。
  - 選択されたファイルをSupabase Storageにアップロードし、取得した公開URLを`profile`テーブルの`icon`カラムに保存します。

---

# チャプター5: ポスト (概要)

このチャプターでは、投稿機能、タイムライン表示、投稿詳細表示、そして投稿に対するリアクション（いいね・リツイート）の基本的な実装方針を説明します。

### 5.1. 投稿フォームと投稿処理

- **目的:** ユーザーが新しいポストを作成できるようにします。
- **UI (`components/PostForm.tsx`):**
  - テキスト入力エリアと「ポストする」ボタンを設置します。
  - ユーザーアイコンも表示します。
- **データ処理:**
  - 入力された内容とユーザーIDをSupabaseの`posts`テーブルに保存します。
  - 投稿成功後、入力エリアをクリアします。
- **テーブル (`posts`):** `id`, `user_id`, `content`, `created_at`, (オプションで `image_url`)

### 5.2. タイムライン表示

- **目的:** ホームページ (`app/page.tsx`) に、フォローしているユーザーの投稿やリツイートを時系列で表示します。
- **データ取得:**
  - Supabaseから`posts`テーブルのデータを取得し、関連する`profile`テーブルの情報（投稿者の名前やアイコン）も結合して取得します。
  - 新しい投稿が上に来るようにソートします。
- **UI (`components/Post.tsx`):** 各投稿情報を整形して表示するコンポーネントを作成します。

### 5.3. 投稿詳細ページ

- **目的:** 個別の投稿を詳細に表示するページを作成します。
- **UI (`app/[userId]/[postId]/page.tsx`):**
  - 特定の投稿IDに基づいて投稿内容、投稿者情報、投稿日時などを表示します。
  - 返信フォームや返信一覧もこのページに配置します（詳細はチャプター7）。
- **データ取得:** Supabaseから指定された`postId`の投稿データを取得します。

### 5.4. いいね機能

- **目的:** ユーザーが投稿に「いいね」を付けたり外したりできるようにし、各投稿のいいね数を表示します。
- **データベース (`likes` テーブル):** `user_id`, `post_id`, `created_at`。`user_id`と`post_id`でユニーク制約。
- **APIエンドポイント:** `/api/posts/:postId/like` (POST), `/api/posts/:postId/unlike` (DELETE)。
- **フロントエンド:** いいねボタンといいね数を表示し、クリックでAPI連携・UI更新。

### 5.5. リツイート機能

- **目的:** ユーザーが他の投稿を共有（リツイート）できるようにします。
- **データベース (`retweets` テーブル):** `user_id`, `post_id`, `created_at`。`user_id`と`post_id`でユニーク制約。
- **APIエンドポイント:** `/api/posts/:postId/retweet` (POST), `/api/posts/:postId/unretweet` (DELETE)。
- **フロントエンド:** リツイートボタンとリツイート数を表示。タイムラインにはリツイート投稿も表示。

---

# チャプター6: フォロー (概要)

このチャプターでは、ユーザー間でフォロー関係を構築し、フォロー/フォロワー数を表示する機能の基本的な実装方針を説明します。

### 6.1. フォロー・アンフォロー機能

- **目的:** ユーザーが他のユーザーをフォローしたり、フォローを解除したりできるようにします。
- **データベース (`follows` テーブル):**
  - `follower_id` (フォローする側のユーザーID)
  - `following_id` (フォローされる側のユーザーID)
  - `created_at`
  - `follower_id` と `following_id` の組み合わせでユニーク制約。
- **データベース関数:**
  - `get_following_count(userId)`: フォロー数を取得。
  - `get_followers_count(userId)`: フォロワー数を取得。
  - `is_following(currentUserId, targetUserId)`: フォロー状態を確認。
- **APIエンドポイント:**
  - `POST /api/users/:userId/follow`: 特定のユーザーをフォローする。
  - `DELETE /api/users/:userId/unfollow`: 特定のユーザーのフォローを解除する。
  - `GET /api/users/:userId/follow_status`: フォロー状態を確認する。
- **フロントエンド:**
  - プロフィールページや投稿者情報部分にフォロー/アンフォローボタンを設置。
  - ボタンクリックでAPIを呼び出し、UI（ボタン表示、フォロワー数など）を更新。

### 6.2. フォロー/フォロワー数の表示

- **目的:** 各ユーザーのプロフィールページにフォロー数とフォロワー数を表示します。
- **データ取得:** 上記のデータベース関数や直接クエリを用いて、プロフィール表示時にフォロー数・フォロワー数を取得します。
- **UI:** プロフィール情報の一部として表示します。（将来的にはクリックで一覧ページへ遷移）

---

# チャプター7: リプライ (概要)

このチャプターでは、投稿に対してユーザーが返信（リプライ）を作成し、表示する機能の基本的な実装方針を説明します。

### 7.1. リプライ作成機能

- **目的:** ユーザーが特定の投稿に対してコメント（リプライ）を投稿できるようにします。
- **データベース (`replies` テーブル):**
  - `id`, `user_id`, `post_id`, `content`, `created_at`。
  - `user_id` は `profile(id)` を、`post_id` は `posts(id)` を参照。
- **UI (`components/ReplyForm.tsx`):**
  - 投稿詳細ページにリプライ入力フォームを設置。
- \*\*APIエンドポイント (`POST /api/posts/:postId/reply`):
  - 認証ユーザーが特定の投稿にリプライ内容を送信できるようにします。
  - 成功時には新しく作成されたリプライデータを返します。

### 7.2. リプライ一覧表示

- **目的:** 特定の投稿に紐づくリプライの一覧を表示します。
- \*\*APIエンドポイント (`GET /api/posts/:postId/replies`):
  - 特定の投稿IDに紐づくリプライを、投稿者情報（`profile`テーブルと結合）と共に取得します。
- \*\*フロントエンド (`app/[userId]/[postId]/page.tsx` 内):
  - APIから取得したリプライ一覧を時系列で表示します。
  - 各リプライには、リプライ投稿者のアイコン、名前、内容、日時などを表示します。
  - リプライ投稿成功時には、一覧に即時反映されるようにします。
